# VPS Telegram Bot (Rust Port) Specification

## 1. 项目概述

本项目旨在将原有的基于 Python 的 VPS 管理 Telegram Bot 移植到 Rust，以提高性能、减少运行时依赖（移除 Python 环境和 `uv`），并提供更安全的系统交互。

该 Bot 允许管理员通过 Telegram 界面监控 VPS 状态、执行维护脚本、管理定时任务以及重启服务器。

## 2. 功能需求

### 2.1 核心功能

*   **Telegram 交互**:
    *   响应 `/start` 命令，显示主菜单。
    *   处理内联键盘 (Inline Keyboard) 回调。
    *   **鉴权**: 仅响应来自环境变量 `TG_CHAT_ID` 指定的管理员用户的请求。其他用户的请求应被拒绝并记录日志。
*   **系统状态监控**:
    *   显示当前系统时区和时间。
    *   检测并显示关键组件 (`Xray`, `Sing-box`) 的安装状态。
    *   显示当前活动的定时任务列表。
*   **维护任务执行**:
    *   **核心维护**: 执行 `/usr/local/bin/vps-maintain-core.sh`。执行后需返回执行结果，并在 5 秒后重启系统。
    *   **规则更新**: 执行 `/usr/local/bin/vps-maintain-rules.sh`。执行后返回结果。
    *   **完整维护**: 依次执行规则更新和核心维护。
*   **定时任务管理**:
    *   支持设置/取消 "核心维护" 定时任务 (默认: 每日 04:00)。
    *   支持设置/取消 "规则更新" 定时任务 (默认: 每周日 07:00)。
    *   **持久化**: 定时任务的配置必须持久化保存，确保服务重启后任务不丢失。
*   **系统操作**:
    *   **查看日志**: 获取 `vps-tg-bot` 服务的最近日志 (通过 `journalctl`) 并发送给用户。
    *   **重启 VPS**: 提供确认步骤，确认后执行系统重启。

### 2.2 排除的功能 (Out of Scope)

*   **Python 环境管理**: 不需要安装 `uv`、Python 或管理虚拟环境。
*   **脚本创建**: 维护脚本 (`vps-maintain-core.sh`, `vps-maintain-rules.sh`) 的创建逻辑应由**安装脚本**处理，而非 Rust 二进制程序本身负责（除非作为初始化命令的一部分，但目前保持职责分离）。Rust 程序仅负责**调用**这些脚本。

## 3. 架构设计

### 3.1 模块划分

*   **`main`**: 程序入口，负责初始化日志、加载配置、启动 Bot 和调度器。
*   **`config`**: 处理环境变量 (`TG_TOKEN`, `TG_CHAT_ID`) 和持久化配置 (定时任务状态)。
*   **`bot`**: 处理 Telegram API 交互，包括命令解析和回调路由。
*   **`system`**: 封装系统调用，如执行 Shell 脚本、获取系统时间、检查文件存在、执行重启命令、读取 journald 日志。
*   **`scheduler`**: 管理定时任务的调度、执行和持久化。

### 3.2 数据流

1.  用户在 Telegram 发送命令/点击按钮。
2.  `bot` 模块接收 Update。
3.  `bot` 验证 `chat_id`。
4.  根据回调数据 (`callback_data`) 分发到相应的处理函数。
5.  处理函数调用 `system` 模块执行操作 或 调用 `scheduler` 模块修改任务。
6.  操作结果通过 `bot` 模块反馈给用户。

## 4. 环境变量与配置

### 4.1 环境变量 (必须)

*   `TG_TOKEN`: Telegram Bot API Token。
*   `TG_CHAT_ID`: 允许访问 Bot 的管理员 Chat ID (数字字符串)。

### 4.2 持久化配置

*   路径: `/etc/vps-tg-bot/state.json` (或类似位置，需确保有写权限)。
*   内容: 存储当前启用的定时任务及其 Cron 表达式。

```json
{
  "core_maintain_schedule": "0 4 * * *",
  "rules_maintain_schedule": "0 7 * * 0"
}
```

## 5. 边缘情况与约束条件

### 5.1 边缘情况

*   **脚本不存在**: 如果 `/usr/local/bin/vps-maintain-core.sh` 等脚本不存在，Bot 应返回明确的错误信息，而不是崩溃。
*   **执行超时**: 脚本执行应设置超时时间 (如核心维护 300秒，规则更新 120秒)，防止僵死进程。
*   **网络错误**: Telegram API 请求失败时应记录日志并尝试重试（如果适用），或通知用户（如果可能）。
*   **并发执行**: 避免同时执行多个维护任务。如果一个任务正在运行，应拒绝新的维护请求。

### 5.2 约束条件

*   **权限**: 程序必须以 `root` 权限运行，以便执行系统更新、重启和读取系统日志。
*   **依赖**: 编译后的二进制文件应尽可能静态链接，减少对目标系统库的依赖 (musl target 优先)。
*   **日志**: 所有操作日志应输出到 `stdout`/`stderr`，由 `systemd-journald` 捕获。

## 6. 安全性

*   **输入验证**: 虽然主要通过 `chat_id` 鉴权，但仍需确保回调数据不包含恶意载荷（虽然在当前设计中回调数据是固定的）。
*   **敏感信息**: `TG_TOKEN` 绝不应硬编码在源码中，必须通过环境变量注入。
*   **最小权限**: 尽管需要 root 权限，但应限制子进程的环境变量泄露。

## 7. 外部脚本接口 (依赖)

Rust 程序依赖以下外部脚本存在并可执行：

1.  `/usr/local/bin/vps-maintain-core.sh`: 核心维护逻辑。
2.  `/usr/local/bin/vps-maintain-rules.sh`: 规则更新逻辑。
3.  `/tmp/vps_maintain_result.txt`: 核心维护结果输出文件。
4.  `/tmp/vps_rules_result.txt`: 规则更新结果输出文件。
