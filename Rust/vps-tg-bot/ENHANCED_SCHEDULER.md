# 增强型定时任务系统

## 功能概述

Rust VPS Telegram Bot 现在支持增强型定时任务系统，可以为不同类型的维护任务设置独立的定时执行计划。

## 新增功能

### 1. 多任务类型支持
系统现在支持以下 5 种维护任务的定时执行：

- **🔄 系统维护**: 完整的系统更新和清理
- **🚀 核心维护**: 系统更新完成后自动重启
- **🌍 规则维护**: 更新系统规则和配置
- **🔧 更新 Xray**: 自动更新 Xray 到最新版本
- **📦 更新 Sing-box**: 自动更新 Sing-box 到最新版本

### 2. 灵活的定时设置
每种任务类型都可以独立设置执行时间：
- **每天执行**: 如每天凌晨4点
- **每周执行**: 如每周日凌晨执行
- **每月执行**: 如每月1号执行
- **自定义**: 支持完整的 Cron 表达式

### 3. 预设时间选项
为每种任务类型提供了智能的默认时间建议：

#### 系统维护
- 每天凌晨4点: `0 4 * * *`
- 每周日凌晨4点: `0 4 * * Sun`
- 每月1号凌晨4点: `0 4 1 * *`

#### 核心维护
- 每周日凌晨5点: `0 5 * * Sun`
- 每月1号凌晨5点: `0 5 1 * *`
- 每两周日凌晨5点: `0 5 */14 * *`

#### 规则维护
- 每天凌晨3点: `0 3 * * *`
- 每6小时: `0 */6 * * *`
- 每周日凌晨3点: `0 3 * * Sun`

#### 更新 Xray
- 每周日凌晨6点: `0 6 * * Sun`
- 每月1号凌晨6点: `0 6 1 * *`
- 每两周日凌晨6点: `0 6 */14 * *`

#### 更新 Sing-box
- 每周日凌晨7点: `0 7 * * Sun`
- 每月1号凌晨7点: `0 7 1 * *`
- 每两周日凌晨7点: `0 7 */14 * *`

## 使用方法

### 1. 主菜单操作
```
🚀 欢迎使用 VPS 管理机器人!

请选择您要执行的操作:
┌─────────────────┬─────────────────┐
│ 📊 系统状态     │ 🛠️ 维护菜单     │
├─────────────────┼─────────────────┤
│ ⏰ 定时任务     │ 📋 任务管理     │
└─────────────────┴─────────────────┘
```

### 2. 定时任务设置
点击 "⏰ 定时任务" 进入任务类型选择：

```
⏰ 定时任务设置

请选择要设置的任务类型:
┌─────────────────┬─────────────────┐
│ 🔄 系统维护     │ 🚀 核心维护     │
├─────────────────┼─────────────────┤
│ 🌍 规则维护     │ 🔧 更新 Xray     │
├─────────────────┼─────────────────┤
│ 📦 更新 Sing-box│ 📋 查看所有任务 │
├─────────────────┴─────────────────┤
│ 🔙 返回                         │
└─────────────────────────────────┘
```

### 3. 任务管理
点击 "📋 任务管理" 管理所有定时任务：

```
📋 任务管理

管理您的定时任务:
┌─────────────────┬─────────────────┐
│ 📋 查看任务列表 │ ➕ 添加新任务    │
├─────────────────┴─────────────────┤
│ 🔄 返回主菜单                   │
└─────────────────────────────────┘
```

### 4. 查看任务列表
```
⏰ 定时任务列表:

1. ✅ 🔄 系统维护 (0 4 * * Sun)
   Cron: 0 4 * * Sun

2. ✅ 🚀 核心维护 (0 5 * * Sun)
   Cron: 0 5 * * Sun

3. ✅ 🌍 规则维护 (0 3 * * *)
   Cron: 0 3 * * *
```

## 技术改进

### 1. 架构重构
- 创建了 `task_types.rs` 模块，定义任务类型和执行逻辑
- 重构了 `scheduler/mod.rs`，支持多任务管理
- 添加了 `ScheduledTask` 结构体管理单个任务配置

### 2. 验证增强
- 改进了 Cron 表达式验证逻辑
- 支持复杂的 Cron 表达式（列表、范围、步长）
- 提供了详细的错误提示

### 3. 任务执行
- 每种任务类型都有独立的执行函数
- 任务执行结果会通过 Telegram 通知
- 支持任务启停状态切换

### 4. 数据持久化
- 任务配置自动保存到 `scheduler_state.json`
- 支持任务添加、删除、修改操作
- 系统重启后任务配置自动恢复

## 配置文件

### scheduler_state.json 示例
```json
{
  "tasks": [
    {
      "task_type": "SystemMaintenance",
      "cron_expression": "0 4 * * Sun",
      "enabled": true
    },
    {
      "task_type": "CoreMaintenance", 
      "cron_expression": "0 5 * * Sun",
      "enabled": true
    },
    {
      "task_type": "RulesMaintenance",
      "cron_expression": "0 3 * * *",
      "enabled": false
    }
  ]
}
```

## 命令行支持

系统仍然支持原有的命令行方式设置任务：

```
/set_schedule <cron_expression>
```

例如：
- `/set_schedule 0 2 * * *` - 每天凌晨2点执行系统维护
- `/set_schedule 0 6 * * Mon` - 每周一上午6点执行

## 优势

1. **独立性**: 每种维护任务可以独立设置执行时间
2. **灵活性**: 支持多种预设时间选项和自定义 Cron 表达式
3. **可靠性**: 任务配置持久化保存，系统重启后自动恢复
4. **可观察性**: 任务执行结果实时通知，便于监控
5. **扩展性**: 架构支持轻松添加新的任务类型

## 故障排除

### 任务不执行
1. 检查任务状态是否为启用 (`enabled: true`)
2. 验证 Cron 表达式格式是否正确
3. 查看系统日志确认任务调度器状态

### 任务执行失败
1. 检查系统权限是否足够执行相应操作
2. 验证网络连接（对于更新任务）
3. 查看具体错误信息进行针对性处理

### 配置问题
1. 确认 `scheduler_state.json` 文件格式正确
2. 检查文件权限是否允许读写
3. 可以删除配置文件让系统重新生成默认配置

## 总结

增强型定时任务系统为 VPS 管理提供了更灵活、更强大的自动化解决方案。用户可以根据实际需求为不同类型的维护任务设置合适的执行时间，实现真正的无人值守运维。