# 改进型定时任务系统 - 交互流程

## 改进说明

根据用户反馈，改进了定时任务设置的交互流程，现在用户在选择"每天"、"每周"或"每月"后，可以进一步自定义具体的执行时间。

## 改进后的交互流程

### 1. 选择任务类型
```
⏰ 定时任务设置

请选择要设置的任务类型:
┌─────────────────┬─────────────────┐
│ 🔄 系统维护     │ 🚀 核心维护     │
├─────────────────┼─────────────────┤
│ 🌍 规则维护     │ 🔧 更新 Xray     │
├─────────────────┼─────────────────┤
│ 📦 更新 Sing-box│ 📋 查看所有任务 │
├─────────────────┴─────────────────┤
│ 🔙 返回                         │
└─────────────────────────────────┘
```

### 2. 选择执行频率
用户选择"🔄 系统维护"后：

```
🔄 系统维护定时设置

请选择执行时间:
┌─────────────────┬─────────────────┐
│ 每天设置        │ 每周设置        │
├─────────────────┼─────────────────┤
│ 每月设置        │ 自定义          │
├─────────────────┴─────────────────┤
│ 🔙 返回任务类型                 │
└─────────────────────────────────┘
```

### 3. 选择具体时间
用户点击"每天设置"后：

```
⏰ 设置 🔄 系统维护 每天执行

请选择具体执行时间:
┌─────────────────┬─────────────────┐
│ 凌晨2点         │ 凌晨3点         │
├─────────────────┼─────────────────┤
│ 凌晨4点         │ 凌晨5点         │
├─────────────────┼─────────────────┤
│ 上午6点         │ 上午7点         │
├─────────────────┼─────────────────┤
│ 上午8点         │ 上午9点         │
├─────────────────┼─────────────────┤
│ 上午10点        │ 上午11点        │
├─────────────────┼─────────────────┤
│ 下午12点        │ 下午13点        │
├─────────────────┼─────────────────┤
│ 下午14点        │ 下午15点        │
├─────────────────┼─────────────────┤
│ 下午16点        │ 下午17点        │
├─────────────────┼─────────────────┤
│ 下午18点        │ 下午19点        │
├─────────────────┼─────────────────┤
│ 晚上20点        │ 晚上21点        │
├─────────────────┼─────────────────┤
│ 晚上22点        │ 晚上23点        │
├─────────────────┼─────────────────┤
│ 深夜0点         │ 深夜1点         │
├─────────────────┴─────────────────┤
│ 🔙 返回                         │
└─────────────────────────────────┘
```

### 4. 任务设置完成
用户选择"凌晨4点"后：

```
🔄 正在设置 🔄 系统维护 任务...
[处理中...]
✅ 新任务已添加: 🔄 系统维护 (0 4 * * *)

任务已成功设置！
```

## 不同频率的时间选项

### 每天执行
- 凌晨2点 - 深夜1点 (24小时选项)
- Cron 格式: `0 [小时] * * *`

### 每周执行
- 周日 凌晨2点 - 周日 晚上23点
- Cron 格式: `0 [小时] * * 0`

### 每月执行
- 1号 凌晨2点 - 1号 晚上23点  
- Cron 格式: `0 [小时] 1 * *`

## 自定义选项

除了预设时间选项，用户还可以选择"自定义"来输入完整的 Cron 表达式：

```
⏰ 自定义定时任务设置

📝 Cron 表达式说明：

• 格式：分 时 日 月 星期（共5个字段）
• 字段说明：
  - 分钟：0-59
  - 小时：0-23
  - 日期：1-31
  - 月份：1-12
  - 星期：0-7（0和7都表示周日）

• 常用示例：
  - `0 4 * * *` - 每天凌晨4点
  - `0 4 * * Sun` - 每周日凌晨4点
  - `0 9 * * 1-5` - 工作日上午9点
  - `30 2 1 * *` - 每月1日凌晨2点30分
  - `0 0 * * 0` - 每周日凌晨0点

💡 如需修改定时任务，请发送命令：
`/set_schedule <cron_expression>`

例如：设置每天凌晨2点执行
`/set_schedule 0 2 * * *`
```

## 任务管理

用户可以在"📋 任务管理"中查看和管理所有定时任务：

```
📋 任务管理

管理您的定时任务:
┌─────────────────┬─────────────────┐
│ 📋 查看任务列表 │ ➕ 添加新任务    │
├─────────────────┴─────────────────┤
│ 🔄 返回主菜单                   │
└─────────────────────────────────┘
```

## 技术实现

### 时间选择键盘
- 使用 `build_time_selection_keyboard()` 函数生成时间选择界面
- 支持每天、每周、每月三种频率的不同时间选项
- 每行显示3个时间选项，便于用户选择

### Cron 表达式生成
- 根据用户选择的频率和时间自动生成正确的 Cron 表达式
- 支持复杂的时间设置逻辑
- 确保生成的表达式符合标准格式

### 用户体验改进
- 减少了用户需要记忆 Cron 表达式格式的负担
- 提供了直观的时间选择界面
- 支持快速设置常用的时间点
- 保留了高级用户的自定义选项

## 优势

1. **直观操作**: 用户不需要学习 Cron 表达式语法
2. **快速设置**: 点击即可设置常用的时间点
3. **灵活选择**: 支持24小时制的时间选择
4. **向后兼容**: 保留了原有的自定义 Cron 表达式功能
5. **用户友好**: 界面清晰，操作流程合理

## 总结

改进后的交互流程让定时任务设置变得更加用户友好，用户可以轻松为不同类型的维护任务设置合适的执行时间，大大提升了使用体验。