# æ¶æ„è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå°† Telegram Bot é€»è¾‘ã€ç³»ç»Ÿå‘½ä»¤å°è£…å’Œå®šæ—¶ä»»åŠ¡åˆ†ç¦»ï¼ŒåŸºäº Go è¯­è¨€å®ç° VPS ç»´æŠ¤è‡ªåŠ¨åŒ–ç³»ç»Ÿã€‚æ¶æ„è®¾è®¡éµå¾ªæ¸…æ™°æ¥å£å®šä¹‰ã€ä¾èµ–æ³¨å…¥å’Œå¯æµ‹è¯•æ€§åŸåˆ™ã€‚

## æ ¸å¿ƒæ¨¡å—

### 1. é…ç½®æ¨¡å— (`pkg/config`)

**èŒè´£**: åŠ è½½å’Œç®¡ç†åº”ç”¨ç¨‹åºé…ç½®

**æ•°æ®ç»“æ„**:
```go
type Config struct {
    TelegramToken string // ä» TG_TOKEN ç¯å¢ƒå˜é‡æˆ–æ ‡å¿—åŠ è½½
    AdminChatID   int64  // ä» TG_CHAT_ID ç¯å¢ƒå˜é‡æˆ–æ ‡å¿—åŠ è½½
    StateFile     string // çŠ¶æ€æŒä¹…åŒ–æ–‡ä»¶è·¯å¾„ (é»˜è®¤: state.json)
}
```

**æ ¸å¿ƒæ¥å£**:
- `Load() error`: ä»ç¯å¢ƒå˜é‡å’Œå‘½ä»¤è¡Œæ ‡å¿—åŠ è½½é…ç½®
- `Validate() error`: éªŒè¯å¿…éœ€å­—æ®µ

**è®¾è®¡åŸåˆ™**:
- æ— ç¡¬ç¼–ç å¯†é’¥ï¼Œæ‰€æœ‰æ•æ„Ÿä¿¡æ¯ä»ç¯å¢ƒå˜é‡è·å–
- æ”¯æŒå‘½ä»¤è¡Œæ ‡å¿—è¦†ç›–ç¯å¢ƒå˜é‡
- é…ç½®éªŒè¯ç¡®ä¿å¿…éœ€å­—æ®µå­˜åœ¨

### 2. ç³»ç»Ÿæ‰§è¡Œæ¨¡å— (`pkg/system`)

**èŒè´£**: æŠ½è±¡æ“ä½œç³»ç»Ÿçº§æ“ä½œï¼Œæä¾›ç»Ÿä¸€çš„ç³»ç»Ÿæ¥å£

**æ ¸å¿ƒæ¥å£ - SystemExecutor**:
```go
type SystemExecutor interface {
    // æ£€æŸ¥æŒ‡å®šç¨‹åºæ˜¯å¦å·²å®‰è£…
    IsInstalled(program string) bool
    
    // è·å–å½“å‰ç³»ç»Ÿæ—¶é—´å’Œæ—¶åŒº
    GetSystemTime() (time.Time, string)
    
    // æ‰§è¡Œ shell å‘½ä»¤
    RunCommand(cmd string, args ...string) (string, error)
    
    // ç‰¹å®šçš„ç»´æŠ¤ä»»åŠ¡åŒ…è£…å™¨
    RunCoreMaintain() (string, error)
    RunRulesMaintain() (string, error)
    
    // ç³»ç»Ÿæ“ä½œ
    Reboot() error
    GetLogs(lines int) (string, error)
}
```

**å®ç°ç­–ç•¥**:
- `IsInstalled`: æ£€æŸ¥ `/usr/local/bin/` å’Œ PATH ç¯å¢ƒå˜é‡
- `RunCoreMaintain`: è°ƒç”¨ `/usr/local/bin/vps-maintain-core.sh`
- `RunRulesMaintain`: è°ƒç”¨ `/usr/local/bin/vps-maintain-rules.sh`
- `GetLogs`: æ‰§è¡Œ `journalctl -u vps-tg-bot -n lines --no-pager`

**æµ‹è¯•ç­–ç•¥**:
- æä¾› Mock å®ç°ç”¨äºå•å…ƒæµ‹è¯•
- æ–‡ä»¶ç³»ç»Ÿæ“ä½œå¯æ¨¡æ‹Ÿ
- å‘½ä»¤æ‰§è¡Œå¯æ‹¦æˆªå’ŒéªŒè¯

### 3. è°ƒåº¦å™¨æ¨¡å— (`pkg/scheduler`)

**èŒè´£**: ç®¡ç† cron ä½œä¸šå¹¶æä¾›çŠ¶æ€æŒä¹…åŒ–

**æ ¸å¿ƒæ¥å£ - JobManager**:
```go
type JobManager interface {
    Start()
    Stop()
    
    // æ·»åŠ æˆ–æ›´æ–°ä½œä¸š
    SetJob(name string, cronExp string, task func()) error
    
    // ç§»é™¤ä½œä¸š
    RemoveJob(name string)
    
    // æ¸…é™¤æ‰€æœ‰ä½œä¸š
    ClearAll()
    
    // è·å–ä½œä¸šçŠ¶æ€
    GetJobStatus(name string) string // è¿”å› "âœ… Schedule" æˆ– "âŒ Not Set"
    
    // çŠ¶æ€æŒä¹…åŒ–
    SaveState() error
    LoadState() error
}
```

**çŠ¶æ€æŒä¹…åŒ–æ ¼å¼**:
```json
{
  "core_maintain": "0 4 * * *",
  "rules_maintain": "0 7 * * 0"
}
```

**æ ¸å¿ƒé€»è¾‘**:
- ä½¿ç”¨ `github.com/robfig/cron/v3` ä½œä¸º cron è°ƒåº¦å™¨
- ä½œä¸šæ³¨å†Œè¡¨ç»´æŠ¤ä»»åŠ¡å‡½æ•°æ˜ å°„
- å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½æŒä¹…åŒ–çŠ¶æ€
- çŠ¶æ€å˜æ›´æ—¶è‡ªåŠ¨ä¿å­˜

**é»˜è®¤ä½œä¸š**:
- `core_maintain`: æ¯å¤© 04:00 æ‰§è¡Œæ ¸å¿ƒç»´æŠ¤
- `rules_maintain`: æ¯å‘¨æ—¥ 07:00 æ‰§è¡Œè§„åˆ™æ›´æ–°

### 4. Telegram Bot æ¨¡å— (`pkg/bot`)

**èŒè´£**: å¤„ç† Telegram ç”¨æˆ·ç•Œé¢å’Œäº¤äº’é€»è¾‘

**æ ¸å¿ƒç»„ä»¶**:

#### 4.1 Bot å¤„ç†å™¨
```go
type BotHandler interface {
    HandleUpdate(update tgbotapi.Update) error
    SendMessage(chatID int64, text string) error
    SendInlineKeyboard(chatID int64, text string, keyboard [][]tgbotapi.InlineKeyboardButton) error
}
```

#### 4.2 è®¤è¯ä¸­é—´ä»¶
- éªŒè¯ç”¨æˆ· Chat ID ä¸é…ç½®çš„ç®¡ç†å‘˜ Chat ID åŒ¹é…
- æœªæˆæƒç”¨æˆ·æ”¶åˆ°è®¿é—®æ‹’ç»æ¶ˆæ¯

#### 4.3 èœå•ç³»ç»Ÿ

**ä¸»èœå•**:
- ğŸ“Š System Status (`status`)
- ğŸ”§ Maintain Now (`maintain_now`)
- âš™ï¸ Schedule Settings (`schedule_menu`)
- ğŸ“‹ View Logs (`view_logs`)
- ğŸ”„ Reboot VPS (`reboot_confirm`)

**ç»´æŠ¤èœå•**:
- ğŸ”§ Core Maintain (`maintain_core`)
- ğŸ“œ Rules Update (`maintain_rules`)
- ğŸ”„ Full Maintain (`maintain_full`)
- ğŸ”™ Back (`back_main`)

**è°ƒåº¦èœå•**:
- â° Set Core (Daily 04:00) (`schedule_core`)
- ğŸ“… Set Rules (Sun 07:00) (`schedule_rules`)
- ğŸ—‘ï¸ Clear All (`schedule_clear`)
- ğŸ”™ Back (`back_main`)

**æ¶ˆæ¯å¤„ç†æµç¨‹**:
1. `/start` å‘½ä»¤ â†’ æ˜¾ç¤ºä¸»èœå•
2. å›è°ƒæŸ¥è¯¢ â†’ æ ¹æ® data å­—æ®µè·¯ç”±åˆ°å¯¹åº”å¤„ç†å™¨
3. æƒé™éªŒè¯ â†’ ç¡®ä¿æ“ä½œæ¥è‡ªç®¡ç†å‘˜
4. æ‰§è¡Œæ“ä½œ â†’ è°ƒç”¨ç›¸åº”æ¨¡å—æ¥å£
5. å“åº”ç”¨æˆ· â†’ å‘é€ç»“æœæ¶ˆæ¯æˆ–æ›´æ–°èœå•

## ç›®å½•ç»“æ„

```
pkg/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ config.go          # é…ç½®ç»“æ„ä½“å’ŒåŠ è½½é€»è¾‘
â”‚   â””â”€â”€ config_test.go     # é…ç½®æµ‹è¯•
â”œâ”€â”€ system/
â”‚   â”œâ”€â”€ executor.go        # SystemExecutor æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ executor_impl.go   # ç³»ç»Ÿæ‰§è¡Œå™¨å®ç°
â”‚   â””â”€â”€ executor_test.go   # ç³»ç»Ÿæ‰§è¡Œå™¨æµ‹è¯•
â”œâ”€â”€ scheduler/
â”‚   â”œâ”€â”€ scheduler.go       # JobManager æ¥å£å’Œå®ç°
â”‚   â””â”€â”€ scheduler_test.go  # è°ƒåº¦å™¨æµ‹è¯•
â””â”€â”€ bot/
    â”œâ”€â”€ handler.go         # Bot å¤„ç†å™¨
    â”œâ”€â”€ menu.go           # èœå•ç”Ÿæˆé€»è¾‘
    â””â”€â”€ bot_test.go       # Bot æµ‹è¯•
```

## æ•°æ®æµæ¶æ„

```
Telegram Update
    â†“
Bot Handler (è®¤è¯ + è·¯ç”±)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Menu Handler  â”‚  Action Handler â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   System Exec   â”‚   Scheduler    â”‚
â”‚   (Commands)    â”‚   (Cron Jobs)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“                    â†“
Response Message    Persistent State
```

## ä¾èµ–å…³ç³»

```
main.go
    â”œâ”€â”€ Config (pkg/config)
    â”œâ”€â”€ System Executor (pkg/system)
    â”œâ”€â”€ Job Manager (pkg/scheduler)
    â””â”€â”€ Bot Handler (pkg/bot)
        â””â”€â”€ Depends on: Config, System, Scheduler
```

## æ‰©å±•æ€§è®¾è®¡

### æ·»åŠ æ–°ç»´æŠ¤ä»»åŠ¡
1. åœ¨ `pkg/system` ä¸­å®ç°æ–°çš„ `RunXXXMaintain() (string, error)` æ–¹æ³•
2. åœ¨ `pkg/scheduler` ä¸­æ³¨å†Œä»»åŠ¡å‡½æ•°
3. åœ¨ `pkg/bot` ä¸­æ·»åŠ èœå•é¡¹å’Œå¤„ç†å™¨

### æ·»åŠ æ–°ç³»ç»Ÿæ“ä½œ
1. æ‰©å±• `SystemExecutor` æ¥å£
2. å®ç°å…·ä½“æ–¹æ³•
3. åœ¨ Bot å¤„ç†å™¨ä¸­æ·»åŠ è°ƒç”¨é€»è¾‘

### æ·»åŠ æ–° Bot å‘½ä»¤
1. åœ¨èœå•å®šä¹‰ä¸­æ·»åŠ æ–°æŒ‰é’®
2. å®ç°å›è°ƒå¤„ç†å™¨
3. æ·»åŠ ç›¸åº”çš„ç³»ç»Ÿæˆ–è°ƒåº¦å™¨è°ƒç”¨

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- **Config**: æµ‹è¯•ç¯å¢ƒå˜é‡åŠ è½½å’ŒéªŒè¯
- **System**: ä½¿ç”¨ Mock éªŒè¯å‘½ä»¤æ‰§è¡Œé€»è¾‘
- **Scheduler**: æµ‹è¯•ä½œä¸šç®¡ç†å’ŒæŒä¹…åŒ–
- **Bot**: æµ‹è¯•æ¶ˆæ¯è·¯ç”±å’Œèœå•ç”Ÿæˆ

### é›†æˆæµ‹è¯•
- ç«¯åˆ°ç«¯ Bot äº¤äº’æµ‹è¯•
- è°ƒåº¦å™¨ä¸ç³»ç»Ÿå‘½ä»¤é›†æˆæµ‹è¯•
- é…ç½®åŠ è½½åˆ° Bot å¯åŠ¨çš„å®Œæ•´æµç¨‹

## éƒ¨ç½²æ¶æ„

### è¿è¡Œæ—¶è¦æ±‚
- Go 1.21+
- systemd æœåŠ¡ç®¡ç†
- Telegram Bot Token (ç¯å¢ƒå˜é‡)
- ç®¡ç†å‘˜ Chat ID (ç¯å¢ƒå˜é‡)

### éƒ¨ç½²æ­¥éª¤
1. ç¼–è¯‘ Go åº”ç”¨: `go build -o vps-tg-bot ./cmd/vps-tg-bot`
2. å®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„: `/usr/local/bin/vps-tg-bot`
3. é…ç½® systemd æœåŠ¡
4. è®¾ç½®ç¯å¢ƒå˜é‡
5. å¯åŠ¨æœåŠ¡: `systemctl start vps-tg-bot`

## å®‰å…¨è€ƒè™‘

### è®¿é—®æ§åˆ¶
- ä»…ç®¡ç†å‘˜ Chat ID å¯è®¿é—® Bot åŠŸèƒ½
- æ‰€æœ‰æ“ä½œéƒ½éœ€è¦æƒé™éªŒè¯

### å‘½ä»¤å®‰å…¨
- ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œå‰éªŒè¯è„šæœ¬å­˜åœ¨
- è¶…æ—¶æ§åˆ¶é˜²æ­¢æ¶æ„å‘½ä»¤
- é”™è¯¯ä¿¡æ¯ä¸æ³„éœ²ç³»ç»Ÿæ•æ„Ÿä¿¡æ¯

### çŠ¶æ€å®‰å…¨
- çŠ¶æ€æ–‡ä»¶æƒé™é™åˆ¶ (0600)
- JSON åºåˆ—åŒ–é”™è¯¯å¤„ç†
- è°ƒåº¦å™¨çŠ¶æ€ä¸€è‡´æ€§éªŒè¯

## æ€§èƒ½ä¼˜åŒ–

### å¹¶å‘å¤„ç†
- Bot æ›´æ–°ä½¿ç”¨ goroutine å¹¶å‘å¤„ç†
- é•¿æ—¶é—´è¿è¡Œçš„ç»´æŠ¤ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ

### èµ„æºç®¡ç†
- å‘½ä»¤æ‰§è¡Œå™¨è¶…æ—¶æ§åˆ¶
- æ—¥å¿—è·å–é™åˆ¶è¡Œæ•°
- æ¶ˆæ¯é•¿åº¦é™åˆ¶é¿å… Telegram é™åˆ¶

### ç¼“å­˜ç­–ç•¥
- ç³»ç»ŸçŠ¶æ€ç¼“å­˜ (60ç§’)
- èœå•ç”Ÿæˆç»“æœç¼“å­˜
- å‘½ä»¤æ‰§è¡Œç»“æœä¸´æ—¶ç¼“å­˜

## ç›‘æ§å’Œæ—¥å¿—

### åº”ç”¨æ—¥å¿—
- ç»“æ„åŒ–æ—¥å¿—è®°å½•æ‰€æœ‰æ“ä½œ
- é”™è¯¯çº§åˆ«åˆ†ç±» (ERROR, WARN, INFO, DEBUG)
- æ“ä½œå®¡è®¡è·Ÿè¸ª

### ç³»ç»Ÿé›†æˆ
- æ—¥å¿—è¾“å‡ºåˆ° systemd journal
- ç»´æŠ¤ä»»åŠ¡æ‰§è¡Œæ—¥å¿—è®°å½•
- Bot äº¤äº’å†å²è®°å½•

## æ•…éšœæ¢å¤

### çŠ¶æ€æ¢å¤
- å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½è°ƒåº¦å™¨çŠ¶æ€
- çŠ¶æ€æ–‡ä»¶æŸåæ—¶çš„å›é€€æœºåˆ¶
- ä½œä¸šæ³¨å†Œå¤±è´¥æ—¶çš„é‡è¯•é€»è¾‘

### é”™è¯¯å¤„ç†
- ç½‘ç»œè¿æ¥é‡è¯•æœºåˆ¶
- å‘½ä»¤æ‰§è¡Œå¤±è´¥çš„å‹å¥½æç¤º
- ç³»ç»Ÿé‡å¯åçš„è‡ªåŠ¨æ¢å¤