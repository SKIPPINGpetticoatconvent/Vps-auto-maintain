# 多级菜单系统测试场景

## 概述

Go 版本的多级菜单系统已成功实现，参考了 Rust 版本的交互逻辑。现在用户可以通过直观的步骤化界面来设置定时任务。

## 新增交互流程

### 1. 主菜单
```
🤖 VPS 管理 Bot

请选择操作：
[📊 系统状态] [🔧 立即维护] [⚙️ 调度设置]
[📋 查看日志] [📜 维护历史] [🔄 重启 VPS]
```

### 2. 调度设置 → 任务类型选择
```
⏰ 定时任务设置

📝 请选择任务类型：
[🔄 核心维护] [🌍 规则维护]
[🔧 更新 Xray] [📦 更新 Sing-box]
[📋 查看任务列表] [🔙 返回主菜单]
```

### 3. 频率选择
选择任务类型后，进入频率选择界面：
```
⏰ 🔄 核心维护 定时设置

📝 请选择执行频率：
[🗓️ 每日执行] [📅 每周执行]
[⚙️ 自定义 Cron] [🔙 返回任务类型]
```

### 4. 时间选择网格 (每日/每周模式)
选择每日或每周后，显示可视化时间选择网格：
```
⏰ 🔄 核心维护 每日执行

🕒 请选择具体执行时间：
[深夜0点] [深夜1点] [凌晨2点]
[凌晨3点] [凌晨4点] [凌晨5点]
[上午6点] [上午7点] [上午8点]
[上午9点] [上午10点] [上午11点]
[下午12点] [下午13点] [下午14点]
[下午15点] [下午16点] [下午17点]
[下午18点] [晚上19点] [晚上20点]
[晚上21点] [晚上22点] [晚上23点]
[🔙 返回频率选择]
```

### 5. 自定义 Cron 模式
选择自定义 Cron 后：
```
⏰ 🔄 核心维护 自定义定时设置

📝 请发送 Cron 表达式：

*示例：*
• 每天凌晨4点: `0 4 * * *`
• 每周日凌晨4点: `0 4 * * Sun`
• 每月1号凌晨4点: `0 4 1 * *`

[🔙 返回频率选择] [🔙 返回任务类型]

请输入 Cron 表达式：
```

## 完整测试场景

### 场景 1：设置每日核心维护任务

1. **启动 Bot** → 发送 `/start`
2. **选择调度设置** → 点击 `⚙️ 调度设置`
3. **选择任务类型** → 点击 `🔄 核心维护`
4. **选择频率** → 点击 `🗓️ 每日执行`
5. **选择时间** → 点击 `凌晨4点`
6. **确认设置** → 系统显示：
   ```
   ⏰ 任务设置确认
   
   ✅ 任务类型: 🔄 核心维护
   ✅ 执行频率: 每日
   ✅ 执行时间: 凌晨4点
   ✅ Cron 表达式: `0 4 * * *`
   
   🔄 正在设置定时任务...
   
   ✅ 定时任务设置成功
   
   🔧 任务: 🔄 核心维护
   ⏰ 时间: 每日 凌晨4点
   🆔 Cron: `0 4 * * *`
   ```

### 场景 2：设置每周规则维护任务

1. **选择任务类型** → 点击 `🌍 规则维护`
2. **选择频率** → 点击 `📅 每周执行`
3. **选择时间** → 点击 `周日 上午7点`
4. **确认设置** → 系统生成 Cron: `0 7 * * 0`

### 场景 3：自定义 Cron 表达式

1. **选择任务类型** → 点击 `🔧 更新 Xray`
2. **选择频率** → 点击 `⚙️ 自定义 Cron`
3. **输入表达式** → 用户发送 `0 6 15 * *` (每月15号6点)
4. **确认设置** → 系统显示成功消息

### 场景 4：查看任务列表

1. **从任务类型菜单** → 点击 `📋 查看任务列表`
2. **查看结果** → 显示：
   ```
   📋 任务列表
   
   ✅ 核心维护 定时任务
      任务: 🔄 核心维护
      时间: `0 4 * * *`
      ID: 1
   
   ✅ 规则维护 定时任务  
      任务: 🌍 规则维护
      时间: `0 7 * * 0`
      ID: 2
   
   [➕ 添加任务] [🔙 返回]
   ```

## 技术实现要点

### 1. 菜单流程管理
- **步骤 1**: 任务类型选择 (Core, Rules, UpdateXray, UpdateSingbox)
- **步骤 2**: 频率选择 (每日, 每周, 自定义 Cron)
- **步骤 3**: 时间选择或自定义输入

### 2. UI 组件
- `BuildTaskTypeMenu()` - 生成任务类型选择菜单
- `BuildFrequencyMenu()` - 生成频率选择菜单  
- `BuildTimeSelectionKeyboard()` - 生成可视化时间选择网格
- `HandleCustomCronInput()` - 处理自定义 Cron 输入

### 3. 回调处理
- 智能解析回调数据 (`menu_task_`, `menu_freq_`, `menu_time_`)
- 状态管理和步骤跳转
- 错误处理和用户反馈

### 4. 调度器集成
- 使用 `scheduler.AddJob()` 接口保存用户配置
- 自动生成描述性任务名称
- 实时状态保存和恢复

### 5. 用户体验优化
- 清晰的中文标签和时间显示
- 直观的网格布局（每行3个按钮）
- 详细的确认信息和错误提示
- 流畅的步骤间跳转

## 文件结构

```
Go/pkg/bot/
├── handler.go      # 主处理器（已更新集成新菜单）
├── menus.go        # 新增多级菜单系统
├── router.go       # 路由（保持原有结构）
└── bot_test.go     # 测试文件
```

## 兼容性

新菜单系统与现有功能完全兼容：
- 原有的直接命令（如 `schedule_core`）仍然可用
- 主菜单和其他功能保持不变
- 调度器接口无变化
- 状态持久化机制保持一致

## 测试建议

1. **功能测试**: 按照上述场景逐一测试
2. **边界测试**: 测试无效的 Cron 表达式
3. **流程测试**: 测试各种返回路径
4. **并发测试**: 测试多用户同时操作
5. **状态测试**: 重启后验证任务持久化

这个多级菜单系统大大提升了用户体验，使定时任务的设置变得直观和便捷。