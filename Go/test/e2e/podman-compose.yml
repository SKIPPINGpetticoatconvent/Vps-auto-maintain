# Podman E2E 测试 Compose 文件
# 用于模拟真实 VPS 环境的端到端测试

version: '3.8'

services:
  # VPS 模拟环境 - 运行 Bot
  vps-bot:
    build:
      context: ../..
      dockerfile: test/e2e/Dockerfile.e2e
    container_name: vps-tg-bot-e2e
    environment:
      - TG_TOKEN=${TG_TOKEN:-test_token_123456789:ABCdefGHIjklMNOpqrsTUVwxyz}
      - TG_CHAT_ID=${TG_CHAT_ID:-123456789}
      - CORE_SCRIPT=/usr/local/bin/vps-maintain-core.sh
      - RULES_SCRIPT=/usr/local/bin/vps-maintain-rules.sh
      - STATE_FILE=/app/state.json
      - TEST_MODE=true
    volumes:
      - e2e-state:/app/state
    networks:
      - e2e-network
    healthcheck:
      test: ["CMD", "pgrep", "-f", "vps-tg-bot"]
      interval: 10s
      timeout: 5s
      retries: 3

  # E2E 测试执行器
  e2e-tester:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: builder
    container_name: vps-tg-bot-e2e-tester
    environment:
      - TG_TOKEN=${TG_TOKEN:-test_token_123456789:ABCdefGHIjklMNOpqrsTUVwxyz}
      - TG_CHAT_ID=${TG_CHAT_ID:-123456789}
      - TEST_MODE=true
    volumes:
      - ../../:/build:ro
      - e2e-results:/app/test-results
    working_dir: /build
    networks:
      - e2e-network
    command: ["go", "test", "-v", "-run", "TestE2E_", "./test/e2e/...", "-count=1"]
    depends_on:
      vps-bot:
        condition: service_healthy
    profiles:
      - test

  # 脚本验证服务
  script-validator:
    build:
      context: ../..
      dockerfile: test/e2e/Dockerfile.e2e
    container_name: vps-tg-bot-script-validator
    environment:
      - TEST_MODE=true
    networks:
      - e2e-network
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "=== 验证维护脚本 ==="
        echo ""
        echo "1. 核心维护脚本:"
        /usr/local/bin/vps-maintain-core.sh
        echo ""
        echo "2. 规则维护脚本:"
        /usr/local/bin/vps-maintain-rules.sh
        echo ""
        echo "3. Xray 重启:"
        /usr/local/bin/x-ui restart
        echo ""
        echo "4. Sing-box 重启:"
        /usr/local/bin/sb restart
        echo ""
        echo "=== 所有脚本验证通过 ==="
    profiles:
      - validate

networks:
  e2e-network:
    driver: bridge

volumes:
  e2e-state:
  e2e-results:
