name: Go E2E Tests with Podman

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Go/**'
      - '!.github/workflows/go-e2e-tests.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'Go/**'

env:
  GO_VERSION: '1.21'
  PODMAN_VERSION: '4.9'

jobs:
  # Go 单元测试
  go-unit-tests:
    name: Go Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.21', '1.22']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        path: ./Go

    - name: Set up Go ${{ matrix.go-version }}
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}
        cache-dependency-path: Go/go.sum

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-${{ matrix.go-version }}-
          ${{ runner.os }}-go-

    - name: Install dependencies
      working-directory: Go
      run: |
        go mod download
        go mod verify

    - name: Run Go unit tests
      working-directory: Go
      run: |
        go test -v -race -coverprofile=coverage.out ./...
        go tool cover -html=coverage.out -o coverage.html

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: Go/coverage.out
        flags: go-unittests
        name: go-codecov-${{ matrix.go-version }}

    - name: Run Go linter
      working-directory: Go
      run: |
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
        golangci-lint run

  # Go 集成测试
  go-integration-tests:
    name: Go Integration Tests
    runs-on: ubuntu-latest
    needs: go-unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        path: ./Go

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache-dependency-path: Go/go.sum

    - name: Run integration tests
      working-directory: Go
      run: |
        go test -v -tags integration ./test/integration/...

  # Podman E2E 测试
  podman-e2e-tests:
    name: Podman E2E Tests
    runs-on: ubuntu-latest
    needs: [go-unit-tests, go-integration-tests]
    timeout-minutes: 60
    strategy:
      matrix:
        distro: [debian, ubuntu, centos]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        path: ./Go

    - name: Set up Podman
      run: |
        sudo apt-get update
        sudo apt-get install -y podman
        podman --version

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache-dependency-path: Go/go.sum

    - name: Build Go binary
      working-directory: Go
      run: |
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o vps-tg-bot ./cmd/vps-tg-bot

    - name: Run basic E2E tests
      working-directory: Go/test/e2e
      run: |
        chmod +x run_podman_e2e.sh
        ./run_podman_e2e.sh --go-tests

    - name: Run container E2E tests
      working-directory: Go/test/e2e
      run: |
        chmod +x run_podman_e2e.sh
        ./run_podman_e2e.sh --build-only

    - name: Test container execution
      working-directory: Go/test/e2e
      run: |
        chmod +x run_podman_e2e.sh
        ./run_podman_e2e.sh --run-only

    - name: Run performance tests
      working-directory: Go/test/e2e
      run: |
        go test -v -run TestPerformance_ ./performance_test.go ./bot_e2e_test.go -timeout=5m

    - name: Run security tests
      working-directory: Go/test/e2e
      run: |
        go test -v -run TestSecurity_ ./security_test.go ./bot_e2e_test.go -timeout=3m

  # 多发行版兼容性测试
  multi-distro-tests:
    name: Multi-Distro Compatibility Tests
    runs-on: ubuntu-latest
    needs: go-unit-tests
    timeout-minutes: 45
    strategy:
      matrix:
        include:
          - distro: debian
            dockerfile: Dockerfile.debian
            tag: debian:bookworm-slim
          - distro: ubuntu
            dockerfile: Dockerfile.ubuntu
            tag: ubuntu:22.04
          - distro: centos
            dockerfile: Dockerfile.centos
            tag: quay.io/centos/centos:stream9
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        path: ./Go

    - name: Set up Podman
      run: |
        sudo apt-get update
        sudo apt-get install -y podman

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache-dependency-path: Go/go.sum

    - name: Build binary for Linux
      working-directory: Go
      run: |
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o vps-tg-bot ./cmd/vps-tg-bot

    - name: Build ${{ matrix.distro }} test image
      working-directory: Go/test/container
      run: |
        podman build -f ${{ matrix.dockerfile }} -t vps-tg-bot-${{ matrix.distro }}-test .

    - name: Test ${{ matrix.distro }} container
      working-directory: Go/test/container
      run: |
        podman run --rm vps-tg-bot-${{ matrix.distro }}-test /bin/bash -c "
          echo 'Testing ${{ matrix.distro }} environment...';
          /usr/local/bin/x-ui status;
          /usr/local/bin/sb status;
          echo '${{ matrix.distro }} test completed successfully';
        "

    - name: Test package manager compatibility
      working-directory: Go/test/container
      run: |
        case "${{ matrix.distro }}" in
          "debian"|"ubuntu")
            podman run --rm vps-tg-bot-${{ matrix.distro }}-test apt-get update
            ;;
          "centos")
            podman run --rm vps-tg-bot-${{ matrix.distro }}-test dnf check-update
            ;;
        esac

  # 安全性测试
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: go-unit-tests
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        path: ./Go

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache-dependency-path: Go/go.sum

    - name: Run security tests
      working-directory: Go/test/e2e
      run: |
        go test -v -run TestSecurity_ ./security_test.go ./bot_e2e_test.go -timeout=5m

    - name: Run vulnerability scan
      working-directory: Go
      run: |
        go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
        gosec ./...

    - name: Check for hardcoded secrets
      working-directory: Go
      run: |
        go install github.com/trivago/tform/cmd/tform@latest
        tform --check .

  # 性能基准测试
  performance-tests:
    name: Performance Benchmark Tests
    runs-on: ubuntu-latest
    needs: go-unit-tests
    timeout-minutes: 20
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        path: ./Go

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache-dependency-path: Go/go.sum

    - name: Run performance benchmarks
      working-directory: Go
      run: |
        go test -bench=. -benchmem ./...

    - name: Run E2E performance tests
      working-directory: Go/test/e2e
      run: |
        go test -v -run TestPerformance_StressTest ./performance_test.go ./bot_e2e_test.go -timeout=10m

    - name: Performance regression check
      working-directory: Go/test/e2e
      run: |
        # 运行性能测试并检查结果
        go test -v -run TestPerformance_BasicResponseTime ./performance_test.go ./bot_e2e_test.go

  # 构建和发布
  build-and-package:
    name: Build and Package
    runs-on: ubuntu-latest
    needs: [go-unit-tests, go-integration-tests, podman-e2e-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        path: ./Go

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Build binaries for multiple platforms
      working-directory: Go
      run: |
        # Linux AMD64
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o dist/vps-tg-bot-linux-amd64 ./cmd/vps-tg-bot
        
        # Linux ARM64
        CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o dist/vps-tg-bot-linux-arm64 ./cmd/vps-tg-bot
        
        # Windows AMD64
        CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o dist/vps-tg-bot-windows-amd64.exe ./cmd/vps-tg-bot
        
        # macOS AMD64
        CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o dist/vps-tg-bot-darwin-amd64 ./cmd/vps-tg-bot
        
        # macOS ARM64
        CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o dist/vps-tg-bot-darwin-arm64 ./cmd/vps-tg-bot

    - name: Build Docker image
      working-directory: Go
      run: |
        docker build -t vps-tg-bot:latest .

    - name: Build Podman image
      working-directory: Go
      run: |
        podman build -t vps-tg-bot:latest .

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: go-build-artifacts
        path: Go/dist/

    - name: Upload Docker image
      if: github.ref == 'refs/heads/main'
      run: |
        echo "Docker image built successfully"
        docker images

  # 测试报告
  test-report:
    name: Test Report
    runs-on: ubuntu-latest
    needs: [go-unit-tests, go-integration-tests, podman-e2e-tests, security-tests]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        path: ./Go

    - name: Download test artifacts
      uses: actions/download-artifact@v3
      with:
        name: go-build-artifacts
        path: ./artifacts

    - name: Generate test report
      run: |
        echo "# Go E2E Test Report" > test-report.md
        echo "" >> test-report.md
        echo "## Test Summary" >> test-report.md
        echo "- **Unit Tests**: ${{ needs.go-unit-tests.result }}" >> test-report.md
        echo "- **Integration Tests**: ${{ needs.go-integration-tests.result }}" >> test-report.md
        echo "- **E2E Tests**: ${{ needs.podman-e2e-tests.result }}" >> test-report.md
        echo "- **Security Tests**: ${{ needs.security-tests.result }}" >> test-report.md
        echo "" >> test-report.md
        echo "## Build Artifacts" >> test-report.md
        ls -la ./artifacts >> test-report.md

    - name: Upload test report
      uses: actions/upload-artifact@v3
      with:
        name: go-test-report
        path: Go/test-report.md

  # 通知
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [test-report]
    if: always()
    
    steps:
    - name: Notify success
      if: ${{ needs.test-report.result == 'success' }}
      run: |
        echo "✅ All Go E2E tests passed successfully!"

    - name: Notify failure
      if: ${{ needs.test-report.result == 'failure' }}
      run: |
        echo "❌ Some Go E2E tests failed. Please check the logs."