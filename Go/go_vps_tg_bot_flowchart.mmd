flowchart TD
    %% ========================================
    %% 应用程序启动流程
    %% ========================================
    
    START([应用程序启动]) --> LOAD_CONFIG[加载配置<br/>pkg/config: Load()]
    LOAD_CONFIG --> VALIDATE_CONFIG[验证配置<br/>Validate()]
    VALIDATE_CONFIG --> INIT_SYSTEM[初始化系统执行器<br/>pkg/system]
    INIT_SYSTEM --> INIT_SCHEDULER[初始化调度器<br/>pkg/scheduler]
    INIT_SCHEDULER --> INIT_BOT[初始化Bot处理器<br/>pkg/bot]
    INIT_BOT --> START_BOT[启动Bot监听<br/>HandleUpdates()]
    
    %% ========================================
    %% Telegram 用户交互流程
    %% ========================================
    
    START_BOT --> WAIT_UPDATE[等待Telegram更新]
    WAIT_UPDATE --> AUTH_CHECK{认证检查<br/>IsAdmin()}
    
    AUTH_CHECK -->|未授权| SEND_DENY[发送拒绝消息]
    SEND_DENY --> WAIT_UPDATE
    
    AUTH_CHECK -->|已授权| ROUTE_MESSAGE{消息路由}
    
    %% 消息类型路由
    ROUTE_MESSAGE -->|文本消息 /start| SHOW_MAIN_MENU[显示主菜单]
    ROUTE_MESSAGE -->|回调查询| ROUTE_CALLBACK{回调路由}
    
    %% 主菜单选项
    SHOW_MAIN_MENU --> MENU_CHOICE{菜单选择}
    MENU_CHOICE -->|status| SHOW_STATUS[显示系统状态<br/>SystemExecutor.GetSystemTime()]
    MENU_CHOICE -->|maintain_now| SHOW_MAINTAIN_MENU[显示维护菜单]
    MENU_CHOICE -->|schedule_menu| SHOW_SCHEDULE_MENU[显示调度菜单]
    MENU_CHOICE -->|view_logs| SHOW_LOGS[显示日志<br/>SystemExecutor.GetLogs()]
    MENU_CHOICE -->|reboot_confirm| REBOOT_CONFIRM[重启确认]
    
    %% 维护菜单选项
    SHOW_MAINTAIN_MENU --> MAINTAIN_CHOICE{维护选择}
    MAINTAIN_CHOICE -->|maintain_core| EXEC_CORE_MAINTAIN[执行核心维护<br/>SystemExecutor.RunCoreMaintain()]
    MAINTAIN_CHOICE -->|maintain_rules| EXEC_RULES_MAINTAIN[执行规则维护<br/>SystemExecutor.RunRulesMaintain()]
    MAINTAIN_CHOICE -->|maintain_full| EXEC_FULL_MAINTAIN[执行完整维护<br/>RunCore + RunRules]
    MAINTAIN_CHOICE -->|back_main| SHOW_MAIN_MENU
    
    %% 调度菜单选项
    SHOW_SCHEDULE_MENU --> SCHEDULE_CHOICE{调度选择}
    SCHEDULE_CHOICE -->|schedule_core| SET_CORE_SCHEDULE[设置核心调度<br/>JobManager.SetJob()]
    SCHEDULE_CHOICE -->|schedule_rules| SET_RULES_SCHEDULE[设置规则调度<br/>JobManager.SetJob()]
    SCHEDULE_CHOICE -->|schedule_clear| CLEAR_ALL_SCHEDULES[清除所有调度<br/>JobManager.ClearAll()]
    SCHEDULE_CHOICE -->|back_main| SHOW_MAIN_MENU
    
    %% 回调路由
    ROUTE_CALLBACK --> CB_STATUS[处理状态回调]
    ROUTE_CALLBACK --> CB_MAINTAIN[处理维护回调]
    ROUTE_CALLBACK --> CB_SCHEDULE[处理调度回调]
    ROUTE_CALLBACK --> CB_LOGS[处理日志回调]
    ROUTE_CALLBACK --> CB_REBOOT[处理重启回调]
    ROUTE_CALLBACK --> CB_BACK[处理返回回调]
    
    %% ========================================
    %% 系统操作流程
    %% ========================================
    
    %% 系统执行器操作
    EXEC_CORE_MAINTAIN --> SYSTEM_CHECK{检查系统工具<br/>SystemExecutor.IsInstalled()}
    EXEC_RULES_MAINTAIN --> SYSTEM_CHECK
    EXEC_FULL_MAINTAIN --> SYSTEM_CHECK
    
    SYSTEM_CHECK -->|工具存在| RUN_SCRIPT[执行维护脚本]
    SYSTEM_CHECK -->|工具不存在| SEND_ERROR[发送错误消息]
    
    RUN_SCRIPT --> CAPTURE_OUTPUT[捕获脚本输出]
    CAPTURE_OUTPUT --> SEND_SUCCESS[发送成功消息]
    
    %% 系统状态检查
    SHOW_STATUS --> GET_UPTIME[获取运行时间]
    GET_UPTIME --> GET_TIMEZONE[获取时区信息]
    GET_TIMEZONE --> FORMAT_STATUS[格式化状态信息]
    FORMAT_STATUS --> SEND_STATUS_MESSAGE[发送状态消息]
    
    %% 系统日志
    SHOW_LOGS --> GET_JOURNAL_LOGS[获取journalctl日志]
    GET_JOURNAL_LOGS --> TRIM_LOGS[裁剪日志长度]
    TRIM_LOGS --> SEND_LOGS_MESSAGE[发送日志消息]
    
    %% 系统重启
    REBOOT_CONFIRM --> CONFIRM_REBOOT{确认重启?}
    CONFIRM_REBOOT -->|确认| EXEC_REBOOT[执行重启<br/>SystemExecutor.Reboot()]
    CONFIRM_REBOOT -->|取消| SHOW_MAIN_MENU
    
    %% ========================================
    %% 调度器流程
    %% ========================================
    
    %% 调度器启动
    INIT_SCHEDULER --> LOAD_PERSISTED_STATE[加载持久化状态<br/>JobManager.LoadState()]
    LOAD_PERSISTED_STATE --> REGISTER_TASKS[注册任务函数]
    REGISTER_TASKS --> START_CRON[启动Cron调度器]
    START_CRON --> WAIT_CRON_TRIGGER[等待Cron触发]
    
    %% 调度任务执行
    WAIT_CRON_TRIGGER --> TRIGGER_CORE{触发核心维护?}
    WAIT_CRON_TRIGGER --> TRIGGER_RULES{触发规则维护?}
    
    TRIGGER_CORE -->|是| EXEC_SCHEDULED_CORE[执行调度核心维护]
    TRIGGER_RULES -->|是| EXEC_SCHEDULED_RULES[执行调度规则维护]
    
    EXEC_SCHEDULED_CORE --> NOTIFY_START[通知开始维护]
    EXEC_SCHEDULED_RULES --> NOTIFY_START
    
    NOTIFY_START --> RUN_SCHEDULED_SCRIPT[运行维护脚本]
    RUN_SCHEDULED_SCRIPT --> NOTIFY_COMPLETE[通知维护完成]
    NOTIFY_COMPLETE --> SAVE_STATE[保存调度状态<br/>JobManager.SaveState()]
    
    %% 状态管理
    SET_CORE_SCHEDULE --> UPDATE_JOB_MAP[更新作业映射]
    SET_RULES_SCHEDULE --> UPDATE_JOB_MAP
    CLEAR_ALL_SCHEDULES --> REMOVE_ALL_JOBS[移除所有作业]
    
    UPDATE_JOB_MAP --> SAVE_STATE
    REMOVE_ALL_JOBS --> SAVE_STATE
    
    %% ========================================
    %% 错误处理和恢复
    %% ========================================
    
    SEND_ERROR --> ERROR_LOG[记录错误日志]
    ERROR_LOG --> WAIT_UPDATE
    
    %% 状态文件错误处理
    LOAD_PERSISTED_STATE -->|文件不存在| CREATE_DEFAULT_STATE[创建默认状态]
    LOAD_PERSISTED_STATE -->|文件损坏| LOG_CORRUPTED[记录损坏日志]
    
    CREATE_DEFAULT_STATE --> START_CRON
    LOG_CORRUPTED --> START_CRON
    
    %% 调度器错误恢复
    SAVE_STATE -->|保存失败| LOG_SAVE_ERROR[记录保存错误]
    LOG_SAVE_ERROR --> CONTINUE_OPERATION[继续操作]
    
    %% ========================================
    %% 模块依赖关系
    %% ========================================
    
    subgraph "核心模块"
        CONFIG[配置模块<br/>pkg/config]
        SYSTEM[系统模块<br/>pkg/system]
        SCHEDULER[调度器模块<br/>pkg/scheduler]
        BOT[Bot模块<br/>pkg/bot]
    end
    
    CONFIG -.->|提供配置| SYSTEM
    CONFIG -.->|提供配置| SCHEDULER
    CONFIG -.->|提供配置| BOT
    SYSTEM -.->|执行命令| SCHEDULER
    BOT -.->|调用接口| SYSTEM
    BOT -.->|调用接口| SCHEDULER
    
    %% ========================================
    %% 数据持久化
    %% ========================================
    
    subgraph "持久化存储"
        STATE_FILE[state.json<br/>调度器状态]
        CONFIG_FILE[配置文件<br/>环境变量]
        LOG_FILE[日志文件<br/>systemd journal]
    end
    
    SAVE_STATE --> STATE_FILE
    LOAD_PERSISTED_STATE --> STATE_FILE
    CONFIG --> CONFIG_FILE
    ERROR_LOG --> LOG_FILE
    
    %% ========================================
    %% 样式定义
    %% ========================================
    
    classDef startEnd fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef process fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef module fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef storage fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    
    class START,startEnd
    class LOAD_CONFIG,VALIDATE_CONFIG,INIT_SYSTEM,INIT_SCHEDULER,INIT_BOT,START_BOT,process
    class AUTH_CHECK,ROUTE_MESSAGE,MENU_CHOICE,MAINTAIN_CHOICE,SCHEDULE_CHOICE,CONFIRM_REBOOT,decision
    class CONFIG,SYSTEM,SCHEDULER,BOT,module
    class STATE_FILE,CONFIG_FILE,LOG_FILE,storage
    class SEND_ERROR,ERROR_LOG,LOG_CORRUPTED,LOG_SAVE_ERROR,error